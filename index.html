<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Connect 4</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px;
    }
 #reviewBoard {
  display: grid;
  grid-template-columns: repeat(7, 60px); /* 7 columns like Connect 4 */
  grid-template-rows: repeat(6, 60px);    /* 6 rows */
  gap: 5px;
  justify-content: center;
  margin: 20px auto;
}



    h1 { color: #333; }

    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 400px;
      margin-bottom: 20px;
    }

    input, button, select {
      margin: 5px 0;
      padding: 10px;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      cursor: pointer;
      background: #3498db;
      color: white;
      border: none;
    }

    button:hover { background: #2980b9; }

    #board {
      display: grid;
      grid-template-columns: repeat(7, 60px);
      grid-template-rows: repeat(6, 60px);
      gap: 5px;
      margin-top: 20px;
    }

    .cell {
      width: 60px;
      height: 60px;
      background: #e0e0e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
    }

    .player1 { background: red; }
    .player2 { background: yellow; }

    .hidden { display: none; }
  </style>
</head>
<body>

  <h1>Connect 4</h1>

  <!-- Register -->
  <div class="container" id="registerDiv">
    <h3>Register</h3>
    <input type="email" id="regEmail" placeholder="Email">
    <input type="text" id="regNick" placeholder="Nickname">
    <button onclick="register()">Register</button>
  </div>

  <!-- Login -->
  <div class="container" id="loginDiv">
    <h3>Login</h3>
    <input type="email" id="loginEmail" placeholder="Email">
    <button onclick="login()">Login</button>
  </div>

  <!-- Game Controls -->
  <div class="container hidden" id="gameControls">
    <h3>Game Menu</h3>
    <p id="welcomeText"></p>
    <button onclick="createGame()">Create New Game</button>
    <button onclick="loadGames()">Load Available Games</button>
    <select id="gameList"></select>
    <button onclick="joinGame()">Join Game</button>
    <hr>
    <!-- --- NEW --- -->
    <button onclick="loadFinishedGames()">Review Finished Games</button>
    <select id="finishedGameList" class="hidden"></select>
    <button id="reviewBtn" class="hidden" onclick="reviewSelectedGame()">Review Selected Game</button>
  </div>

  <!-- Game Board -->
  <div class="container hidden" id="gameArea">
    <h3>Game Board</h3>
    <button onclick="returnToMainMenu()">Return to Main Menu</button>
    <p id="statusText">Waiting for game state...</p>
    <div id="board"></div>
  </div>

  <!-- --- NEW --- Review Panel --- -->
  <div class="container hidden" id="reviewArea">
    <h3>Review Game</h3>
    <button onclick="returnToMainMenu()">Return to Main Menu</button>

    <p id="reviewStatus">Game step: <span id="currentStep">0</span></p>
    <div id="reviewBoard"></div>
    <input type="number" id="stepInput" min="1" max="42" placeholder="Enter step (1-42)">
    <button onclick="goToStep()">Go To Step</button>
    <div style="display: flex; gap: 10px; margin-top: 10px;">
      <button onclick="prevStep()">Previous Step</button>
      <button onclick="nextStep()">Next Step</button>
    </div>
  </div>

  <script>
    const BASE_URL = "https://maziar-temp-project.ir/connect4/api/v1";
    let token = "";
    let nickname = "";
    let email = "";
    let currentGameUUID = "";
    // --- NEW ---
    let reviewGameUUID = "";
    let currentReviewStep = 0;

    window.onload = () => {
      const saved = JSON.parse(localStorage.getItem("userAuth"));
      if (saved && saved.token) {
        token = saved.token;
        nickname = saved.nick_name;
        email = saved.email;
        showGameMenu();
      }
    };

    function returnToMainMenu() {
  document.getElementById("gameArea").classList.add("hidden");
  document.getElementById("reviewArea").classList.add("hidden");
  document.getElementById("gameControls").classList.remove("hidden");

  // Optional: stop any auto-refreshing game updates
  // if you used setInterval for updateBoard:
  if (typeof gameInterval !== "undefined") {
    clearInterval(gameInterval);
  }

  // Reset review/game state if needed
  currentGameUUID = "";
  reviewGameUUID = "";
}


    async function register() {
      const email = document.getElementById("regEmail").value.trim();
      const nick = document.getElementById("regNick").value.trim();
      if (!email || !nick) return alert("Please fill in both fields");

      const res = await fetch(`${BASE_URL}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, nick_name: nick })
      });

      if (!res.ok) {
        const err = await res.text();
        return alert("Registration failed: " + err);
      }

      const data = await res.json();
      saveAuthData(data);
      alert("Registered successfully! Welcome " + data.nick_name);
      showGameMenu();
    }

    async function login() {
      const email = document.getElementById("loginEmail").value.trim();
      if (!email) return alert("Please enter your email");

      const res = await fetch(`${BASE_URL}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      if (!res.ok) {
        const err = await res.text();
        return alert("Login failed: " + err);
      }

      const data = await res.json();
      saveAuthData(data);
      alert("Login successful! Welcome " + data.nick_name);
      showGameMenu();
    }

    function saveAuthData(data) {
      token = data.access_token;
      nickname = data.nick_name;
      email = data.email;
      localStorage.setItem("userAuth", JSON.stringify({ token, nick_name: nickname, email }));
    }

    function showGameMenu() {
      document.getElementById("registerDiv").classList.add("hidden");
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("gameControls").classList.remove("hidden");
      document.getElementById("welcomeText").textContent = `Logged in as: ${nickname}`;
    }

    async function createGame() {
      const res = await fetch(`${BASE_URL}/game/`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Failed to create game");

      currentGameUUID = await res.text();
      alert("Game created: " + currentGameUUID);
      startGame();
    }

    async function loadGames() {
      const res = await fetch(`${BASE_URL}/game/`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Failed to load games");

      const games = await res.json();
      const list = document.getElementById("gameList");
      list.innerHTML = "";
      games.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g.uuid;
        opt.textContent = `${g.player_1_nick} (${g.status})`;
        list.appendChild(opt);
      });
    }

    async function joinGame() {
      const game_uuid = document.getElementById("gameList").value;
      if (!game_uuid) return alert("Please select a game first");

      const res = await fetch(`${BASE_URL}/game/join?game_uuid=${game_uuid}`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Failed to join game");

      currentGameUUID = game_uuid;
      alert("Joined game successfully!");
      startGame();
    }

    function startGame() {
      document.getElementById("gameControls").classList.add("hidden");
      document.getElementById("gameArea").classList.remove("hidden");
      updateBoard();
      setInterval(updateBoard, 1000);
    }

    async function updateBoard() {
      if (!currentGameUUID) return;
      const res = await fetch(`${BASE_URL}/game/current?game_uuid=${currentGameUUID}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return;
      const data = await res.json();
      renderBoard(data.board, "board");
      document.getElementById("statusText").textContent =
        `Turn: ${data.current_turn_nick} | Status: ${data.status}` +
        (data.winner ? ` | Winner: ${data.winner}` : "");
    }

    function renderBoard(boardArray, elementId) {
      const boardDiv = document.getElementById(elementId);
      boardDiv.innerHTML = "";
      if (!Array.isArray(boardArray)) return;

      const rows = 6, cols = 7;
      for (let r = rows - 1; r >= 0; r--) {
        for (let c = 0; c < cols; c++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          const column = boardArray[c];
          const value = column ? column[r] : 0;
          if (value === 1 || value === "1") cell.classList.add("player1");
          if (value === 2 || value === "2") cell.classList.add("player2");
          if (elementId === "board") cell.onclick = () => makeMove(c);
          boardDiv.appendChild(cell);
        }
      }
    }

    async function makeMove(column) {
      if (!currentGameUUID) return;
      const res = await fetch(`${BASE_URL}/game/make-move?game_uuid=${currentGameUUID}&chosen_column=${column}`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Move failed");
      const result = await res.text();
      if (result.toLowerCase().includes("true")) updateBoard();
      else alert("Invalid move or not your turn");
    }

    // --- NEW --- Load finished games
    async function loadFinishedGames() {
      const res = await fetch(`${BASE_URL}/game/?game_status=FINISHED`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Failed to load finished games");

      const games = await res.json();
      const list = document.getElementById("finishedGameList");
      list.classList.remove("hidden");
      list.innerHTML = "";
      games.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g.uuid;
        opt.textContent = `${g.player_1_nick} vs ${g.player_2_nick}`;
        list.appendChild(opt);
      });
      document.getElementById("reviewBtn").classList.remove("hidden");
    }

    async function reviewSelectedGame() {
      const uuid = document.getElementById("finishedGameList").value;
      if (!uuid) return alert("Select a finished game first");
      reviewGameUUID = uuid;
      document.getElementById("gameControls").classList.add("hidden");
      document.getElementById("reviewArea").classList.remove("hidden");
      await loadGameStep();
    }

    async function loadGameStep(step = null) {
      let url = `${BASE_URL}/game/review_game?game_uuid=${reviewGameUUID}`;
      if (step) url += `&game_step=${step}`;
      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) return alert("Failed to fetch step");
      const data = await res.json();
      currentReviewStep = data.step;
      renderBoard(data.board_status, "reviewBoard");
      console.log( renderBoard(data.board_status, "reviewBoard"))
      document.getElementById("currentStep").textContent = currentReviewStep;
    }

    async function goToStep() {
      const step = parseInt(document.getElementById("stepInput").value);
      if (!step || step < 1 || step > 42) return alert("Enter a valid step (1–42)");
      await loadGameStep(step);
    }

    async function nextStep() {
      if (currentReviewStep >= 42) return;
      document.getElementById("stepInput").value = ""; // ✅ clear

      await loadGameStep(currentReviewStep + 1);
    }

    async function prevStep() {
      if (currentReviewStep <= 1) return;
      document.getElementById("stepInput").value = ""; // ✅ clear

      await loadGameStep(currentReviewStep - 1);
    }
  </script>
</body>
</html>
